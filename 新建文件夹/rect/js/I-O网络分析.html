<!DOCTYPE html>
<html>
<head>
	<meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
	<title>All</title>
			
	<link rel="stylesheet" href="./css/jquery-ui.min.css">
	<link href="css/bootstrap-switch-master/dist/css/bootstrap3/bootstrap-switch.min.css" rel="stylesheet">
	<link href="css/bootstrap-3.3.7-dist/css/bootstrap-theme.min.css" rel="stylesheet" />
	<link href="css/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="stylesheets/bootstrap-combobox.css" type="text/css" rel="stylesheet">
	<link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
	<link rel="stylesheet" href="./css/style.css" />

	<style>
		.focusLine {
			fill: none;
			stroke: rgb(0, 0, 0);
			stroke-width: 0.7px;
		}
		.panel-heading {
			padding: 2px 5px;
			font-weight: 600;
			font-size: 12px;
			color: #ffffff;
			background-color:#505050;
			border: none;
		}
		#tooltip {
			position: absolute;
			width: 60px;
			font-family: simsun;
			font-size: 13px;
			text-align: center;
			border-style: solid;
			border-width: 0px;
			border-radius: 5px;
			z-index: 11
		}
		#tooltip_line {
			position: absolute;
			width: 100px;
			font-family: simsun;
			font-size: 15px;
			font-weight:bolder;
			text-align: center;
			border-style: solid;
			border-width: 0px;
			border-radius: 5px;
			z-index: 11
		}
		#tooltip_row {
			position: absolute;
			width: 80px;
			font-family: simsun;
			font-size: 15px;
			font-weight:bolder;
			text-align: center;
			border-style: solid;
			border-width: 0px;
			border-radius: 5px;
			z-index: 11
		}
		#scatterPlotWidgets {
		position: absolzute;
		top: 0px;
		right: 0px;
		background-color: none;
		margin: 0px 0px 0px 4px;
		padding: 0px;
		height: 30px;
		width: 110px;
		}
	
		#amount {
			width: 30px;
			background-color: white;
		}
	
		div#other_button {
			position: absolute;
			top: 0px;
			width: 250px;
			height: 202px;
			border-right: 1px solid #B3B7BF;
	
		}
		.links line {
			stroke: #BF3EFF;
			stroke-opacity: 1;
		}
	
		#MIN_slider {
			margin-top:32px;
			height:8px;
			width: 180px;
			margin-left: 28px;
		}
		#slider_coe {
			margin-top:32px;
			height:8px;
			width: 180px;
			margin-left: 28px;
		}
		#k1_value {
			width: 30px;
			background-color: white;
		}
		#slider_coe_2 {
			margin-top:32px;
			height:8px;
			width: 180px;
			margin-left: 28px;
		}
		#k2_value {
			width: 30px;
			background-color: white;
		}
		div#infor_div{
			position: absolute;
			top:0px;
			left:250px;
			width: 448px;
			height: 202px;
		}
		div#All {
			border: 1px solid #B3B7BF;
			border-radius: 4px;
			position: abosolute;
			width: 1120px;
			height: 780px;
		}
	
		div#select_year {
			background-color: rgb(255, 255, 255);
			border-radius: 4px;
			border: 1px solid #B3B7BF;
			position: absolute;
			margin-left: 5px;
			width: 700px;
			top: 657px;
			height: 202px;
		}
	
		div#force{
			background-color: rgb(255, 255, 255);
			border-radius: 4px;
			border: 1px solid #B3B7BF;
			position: absolute;
			left: 0px;
			top: 0px;
			width: 650;
			height: 650px;
			z-index: 1;
		}
		div#force_out{
			border-radius: 4px;
			position: absolute;
			left: 5px;
			top: 5px;
			width: 650px;
			height: 650px;
			z-index: 1;
		}
		div#rec{
			position: absolute;
			border-radius: 4px;
			background-color: rgb(255, 255, 255);
			border: 1px solid #B3B7BF;
			margin-top: 5px;
			width:630px;
			height:650px;
			left: 708px;
			z-index: 2;
		}
		div#ref{
			position: absolute;
			top: 540px;
			left: 0px;
			z-index: 2;
		}
		div#sankey_out {
			background-color:rgb(255, 255, 255);
			border-radius: 4px;
			border: 1px solid #B3B7BF;
			position: absolute;
			margin-left: 708px;
			width: 630px;
			height: 202px;
			top: 657px;
		}
	
		div#sankey {
			background-color: rgb(255, 255, 255);
			border-radius: 4px;
			border: 1px solid #B3B7BF;
			position: absolute;
			left: 0px;
			width: 630px;
			height: 182px;
			top: 20px;
		}
	
		.nodes circle {
			stroke-width: 1.5px;
		}
	
		rect.bordered {
			stroke: #E6E6E6;
			stroke-width: 2px;
		}
	
		.valueText {
			font-family: arial;
			font-size: 12px;
			text-anchor: middle;
		}
	
		text.mono {
			font-size: 9pt;
			font-family: Consolas, courier;
			fill: #aaa;
		}
	
		text.axis-workweek {
			fill: #000;
		}
	
		text.axis-worktime {
			fill: #000;
		}
	
		table{
			 border-collapse :collapse ;
			 position:absolute;
			 top:22px;
			 left:1px;
		 }
		th.th_1{
			width:100px;
			 height:22px;
			 background-color: #9dbbff;
			 font-size:12px;
			 border :1px solid rgb(255, 255, 255);
			 text-align :center;
		 }
		 th.th_2{
			width:50px;
			 height:22px;
			 background-color: #fcb8cf;
			 border :1px solid rgb(255, 255, 255);
			 font-size:12px;
			 text-align :center;
		 }
		 th.th_3{
			width:195px;
			 height:22px;
			 background-color: #9dbbff;
			 border :1px solid rgb(255, 255, 255);
			 font-size:12px;
	
			 text-align :center;
		 }
		td{
			border :1px solid rgb(192, 188, 192);
			 background-color: rgb(255, 255, 255);
			 font-size:12px;
			 text-align :center;
		}
		#year_value{
			background-color: rgb(224, 227, 233);
			 font-size:12px;
			 text-align :center;
		}
		 
	</style>	
</head>
<body style="background-color: #fbfbfb;">
	<div id="select_year">
		<div id='other_button'>
				<div class="panel-heading" width = 200px;>
						社区发现控制
					</div>
				<span style="float:left;line-height: 20px;  font-size: 12px;margin-top:10px;margin-left:20px;">模块度最小差值:
					<input type="text" id="amount" width=30px style="border:0; color:#f6931f;font-weight:bold;width:30px;background-color:rgb(255, 255, 255);" />
				</span>
				<div id="MIN_slider" style = "margin-top:35px;margin-left:25px;"></div>

				<span style="float:left;line-height: 20px;  font-size: 12px;margin-top:6px;margin-left:20px;">平衡系数:
					<input type="text" id="k1_value" width=30px style="border:0; color:#f6931f;font-weight:bold;width:30px;background-color:rgb(255, 255, 255);" />
				</span>
				<div id="slider_coe" style = "margin-top:35px;margin-left:25px;"></div>

				<span style="float:left;line-height: 20px;  font-size: 12px;margin-top:6px;margin-left:20px;">关联系数:
					<input type="text" id="k2_value" width=30px style="border:0; color:#f6931f;font-weight:bold;width:30px;background-color:rgb(255, 255, 255);" />
				</span>
				<div id="slider_coe_2" style = "margin-top:35px;margin-left:25px;"></div>
				<button type="button" class="btn btn-default btn-xs" id='社区发现'style = "width : 70px;margin-left: 80px;margin-top:15px;">社区发现</button>
		</div>
		<div id = 'infor_div'>
			<div class="panel-heading">
				IOT信息展示
			</div>
			<table >
				<tr>
					<th class = "th_2" style = "background-color: #9dbbff;">年份</th>
					<th class = "th_1">流量</th>
					<th class = "th_1">完全消耗系数</th>
					<th class = "th_3">部门名称</th>
				</tr>
				<tr>
					<th class = "th_2" id = "h_1">1997</th>
					<td id = "t-1-1">
						<text type="text" id = "1-1" width=100px class = "year_value" />	
					</td>
					<td id = "t-1-2" >
						<text type="text" id = "1-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-1-3">
						<text type="text" id = "1-3" width=100px class = "year_value" />	
					</td>
				</tr>
				<tr>
					<th class = "th_2" id ="h_2">2000</th>
					<td  id = "t-2-1">
						<text type="text" id = "2-1" width=100px class = "year_value" />	
					</td>					
					<td  id = "t-2-2">
						<text type="text" id = "2-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-2-3">
						<text type="text" id = "2-3" width=100px class = "year_value" />	
					</td>
				</tr>
				<tr>
					<th class = "th_2" id = "h_3">2002</th>
					<td  id = "t-3-1">
						<text type="text" id = "3-1" width=100px class = "year_value" />	
					</td>
					<td  id = "t-3-2">
						<text type="text" id = "3-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-3-3">
						<text type="text" id = "3-3" width=100px class = "year_value" />	
					</td>
				</tr>
				<tr>
					<th class = "th_2" id = "h_4">2005</th>
					<td  id = "t-4-1">
						<text type="text" id = "4-1" width=100px class = "year_value" />	
					</td>
					<td  id = "t-4-2">
						<text type="text" id = "4-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-4-3">
						<text type="text" id = "4-3" width=100px class = "year_value" />	
					</td>
				</tr>
				<tr>
					<th class = "th_2" id ="h_5">2007</th>
					<td  id = "t-5-1">
						<text type="text" id = "5-1" width=100px class = "year_value" />	
					</td>
					<td  id = "t-5-2">
						<text type="text" id = "5-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-5-3">
						<text type="text" id = "5-3" width=100px class = "year_value" />	
					</td>
				</tr>
				<tr>
					<th class = "th_2" id ="h_6">2010</th>
					<td  id = "t-6-1">
						<text type="text" id = "6-1" width=100px class = "year_value" />	
					</td>
					<td  id = "t-6-2">
						<text type="text" id = "6-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-6-3">
						<text type="text" id = "6-3" width=100px class = "year_value" />	
					</td>
				</tr>
				<tr>
					<th class = "th_2" id = "h_7">2012</th>
					<td  id = "t-7-1">
						<text type="text" id = "7-1" width=100px class = "year_value" />	
					</td>
					<td  id = "t-7-2">
						<text type="text" id = "7-2" width=100px class = "year_value" />	
					</td>
					<td  id = "t-7-3">
						<text type="text" id = "7-3" width=100px class = "year_value" />	
					</td>
				</tr>
			</table>
		</div>
	</div>

	<div id = 'rec'>
			<div class="panel-heading">
				IOT关联矩阵
			</div>
			<span style="font-family: sans-serif;border:0; margin-left:90px;position:absolute; padding-top:0px;top:0px;font-size:12.4px;font-weight:bold;color: #ffffff">当前年份:
				<input type="text" id="cur_year_rec" readonly style="border:0; color: #ffffff;background-color: #fff0; font-weight:bold;padding-left:3px;width: 100px">
			</span>
			<button type="button" class="btn btn-default btn-xs" title="reset opacity"  align="center" id='reset-opacity-rec'style = "padding-top:0px;position:absolute;top:0px;z-index:2;right:0px;width:25px;height:20px;">
				<span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
			</button>
	</div>
	<div id = 'force_out'>
		<div id="force">
			<div class="panel-heading">
				IOT关联网络
			</div>
			<span style="font-family: sans-serif;border:0; margin-left:100px;position:absolute; padding-top:0px;top:0px;font-size:12.4px;font-weight:bold;color: #ffffff">年份选择:</span>
			<select id="selectdata" class="selectpicker show-tick" data-width="fit" style = "position:absolute;margin-top:-21px;margin-left:170px;">
                    <option id = '0' value="1997">1997</option>
                    <option id = '1' value="2000">2000</option>
					<option id = '2' value="2002">2002</option>
					<option id = '3' value="2005">2005</option>
                    <option id = '4' value="2007">2007</option>
					<option id = '5' value="2010">2010</option>
					<option id = '6' value="2012">2012</option>
            </select>
			
			<button type="button" class="btn btn-default btn-xs" title="reset opacity"  align="left" id='reset-opacity'style = "padding-top:0px;position:absolute;top:0px;z-index:2;right:0px;width:25px;height:20px;">
					<span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
			</button>
		</div>

	</div>
	<div id='sankey_out'>
		<div class="panel-heading">
			社区时序演变
		</div>
		<div id='sankey'>
		</div>
	</div>

	<script src="js/raphael.js" type="text/javascript"></script>
	<script src="js/jquery.js" type="text/javascript"></script>
	<script src="js/sankey.js" type="text/javascript"></script>
	<script src="http://apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/jLouvain.js"></script>
	<script src="http://d3js.org/d3.v3.js"></script>
	<script src="js/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
	
</body>
<script type='text/javascript'>

	var width = 700, height = 630;
	var button_width = 80, button_height = 200;

	d3.select("#button")
		.style("width", button_width)
		.style("height", button_height)
		.style("position", "absolute");

	var svg_force = d3.select("#force")
		.append("svg")
		.attr("width", width)
		.attr("height", height);

	d3.select("#All_data_rec")
		.style("height", "35px")
		.style("top", "80px");
	d3.select("#All_data_force")
		.style("height", "35px");
	
	//**********矩阵布局的值****************	
	var margin = { top: 0, right: 0, bottom: 100, left: 0},
		width_rec = 630 - margin.left - margin.right,
		height_rec =630 - margin.top - margin.bottom;

	//*************************矩阵SVG*************************
	var svg_rec = d3.select("#rec").append("svg")
		.attr("width", width_rec + margin.left + margin.right )
		.attr("height", height_rec + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	var svg_ref = d3.select("#ref").append("svg")
		.attr("width", width_rec + margin.left + margin.right)
		.attr("height",50)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	$("#cur_year").val("1997");
	$("#cur_year_rec").val("1997");

		d3.csv("2010.csv", function (data_2010) {
		d3.csv("1997.csv", function (data_1997) {
		d3.csv("2002.csv", function (data_2002) {
		d3.csv("2007.csv", function (data_2007) {
		d3.csv("2012.csv", function (data_2012) {
		d3.csv("2005.csv", function (data_2005) {
		d3.csv("2000.csv", function (data_2000) {
		d3.csv("2010_1.csv", function (data_2010_1) {
		d3.csv("1997_1.csv", function (data_1997_1) {
		d3.csv("2002_1.csv", function (data_2002_1) {
		d3.csv("2007_1.csv", function (data_2007_1) {
		d3.csv("2012_1.csv", function (data_2012_1) {
			d3.csv("2005_1.csv", function (data_2005_1) {
			d3.csv("2000_1.csv", function (data_2000_1) {
					
					var ALL_DATA = [];
					ALL_DATA[0] = data_1997;
					ALL_DATA[1] = data_2000;
					ALL_DATA[2] = data_2002;
					ALL_DATA[3] = data_2005;
					ALL_DATA[4] = data_2007;
					ALL_DATA[5] = data_2010;
					ALL_DATA[6] = data_2012;
					var ALL_DATA_1 = [];
					ALL_DATA_1[0] = data_1997_1;
					ALL_DATA_1[1] = data_2000_1;
					ALL_DATA_1[2] = data_2002_1;
					ALL_DATA_1[3] = data_2005_1;
					ALL_DATA_1[4] = data_2007_1;
					ALL_DATA_1[5] = data_2010_1;
					ALL_DATA_1[6] = data_2012_1;
					for(var i = 0; i< 7;i++)
					{
						$("#"+i).on("click",function(d,i){
							var cur_year = document.getElementById("selectdata").value;
							console.log(document.getElementById("selectdata"));
							var year_arr = ["1997","2000","2002","2005","2007","2010","2012"];
							var index = year_arr.indexOf(cur_year);
							var cur_community_result = [];2323
							$("#cur_year").val(cur_year);
							$("#cur_year_rec").val(cur_year);
							for(var t = 0;t <count;t++)
							{
								ALL_DATA[index][t].community = 0;
								cur_community_result[t] = 0;
							}
							$("#k1_value").val(0);
							slider_k1(ALL_DATA[index],ALL_DATA_1[index],0,0.000001);

							$("#k2_value").val(1);
							slider_k2(ALL_DATA[index],ALL_DATA_1[index],0,0.000001);

							$("#amount").val(0);
							slider_MIN(ALL_DATA[index],ALL_DATA_1[index],0,0.0000001);
							bg_color(cur_community_result,ALL_DATA[index]);
							draw_rec_time(ALL_DATA[index], cur_community_result, ALL_DATA);
							draw_force(ALL_DATA_1[index],ALL_DATA[index],0.00000001);
						});
					}
			//***********************颜色修改***************************
					
					//力引导的线
					var in_c = "#007651";
					var out_c =  "#895e00";
					
					//矩阵图渐变
					var rec_a = d3.rgb(255,255,255);    
					var rec_b = d3.rgb(97,26,125); 
					
					//矩阵图内线的颜色
					var rec_curve = "#09F";
					
					//力引导点的渐变
					var circle_a =d3.rgb(255,255,255);     
					var circle_b =d3.rgb(97,26,125); 
					
					//力引导外环的颜色
					var in_out = '#f86d9d';
					var out_in = "#6293ff";
					
					//社区颜色
					var color_arr = ['#00ff00', '#62ffd0', '#f4a6ff', '#ffd062', '#4d5559', '#ffffe9', '#fb7501'];
					var color_com = d3.scaleOrdinal()
						.domain([ 0, 1, 2, 3, 4, 5,6])
						.range(color_arr);
						
					//初始化下拉框默认为第一个被选中
					document.querySelector("#selectdata").options[0].selected = true;
					var data_1 = ALL_DATA_1[0];
					//console.log("data_1: ",data_1);
					var data = ALL_DATA[0];
					////console.log("********当前选中年份的数据**********");
					//console.log(data);
					var count = 0;
					data.forEach(function (d) {
						count += 1;
					});
					////console.log(count);
					////console.log(data);		

					var gridSize = Math.floor((width_rec + margin.left + margin.right) / count);
					gridSize -=0.4;
					svg_rec.selectAll("text").remove();

					function get(){
						//console.log(1111);
					}
					////console.log(data);
					//******矩阵图的索引***
					var industry = [];
					for(var i = 0; i < count; i++){
						//industry[i] = data[i]['industry'];
						industry[i] = i;
					}
					//下拉框函数
					
				//*******************************画初始背景色矩阵************************

					var nodes =data;
					var community_assignment_result_1 = [];
					for(var i = 0; i < count; i++){
						community_assignment_result_1[i] = 0;
						nodes[i].community = 0;
					}

					var count = 0;
					nodes.forEach(function(d){
						count += 1;
					});
					
				//************************************开始添加矩形内的直方图************************

					function bg_color(community_assignment_result_1,nodes){
						svg_rec.selectAll("rect").remove();
						var count = 0;
						nodes.forEach(function (d){
							count += 1;
						});
						var valuedata = {};
						var valuedata = d3.nest()
							.key(function(d){
								return d.industry; 
							})
							.entries(nodes);

							var rec_ch_int = {};
						for (var i = 0; i < count; i++){
							rec_ch_int[i] = valuedata[i].key;
						}
						var max_com = 0;
						for (var i = 0; i < count; i++) {
							if (max_com < community_assignment_result_1[i])
								max_com = community_assignment_result_1[i];
						}
						var community = [];
						var c = 0;
						for (var i = 0; i <= max_com; i++) {
							for (var j = 0; j < count; j++) {
								if (community_assignment_result_1[j] == i) {
									community[c] = j;
									c++;
								}
							}
						}
						//************矩阵数组处理**************
						var cg_rec = [];
						var u = 0;
						var order = 0;
						for (var i = 0; i <= max_com; i++) {
							for (var j = 0; j < count; j++) {
								var x_order = 0;
								if (nodes[j].community == i) {
									for (var t = 0; t < count; t++) {
										cg_rec[u] = {};
										cg_rec[u].x_order = x_order + 1;
										cg_rec[u].y_order = order;
										cg_rec[u].s_dpt =  rec_ch_int[j];
										cg_rec[u].t_dpt =  rec_ch_int[community[t]];
										cg_rec[u].source = j ;
										cg_rec[u].target = community[t];
										for(var y = 1; y <= 7;y++)
										{
											cg_rec[u][y+7] = parseFloat(ALL_DATA_1[y-1][j][rec_ch_int[community[t]]]);
											cg_rec[u][y] = parseInt(ALL_DATA[y-1][j][rec_ch_int[community[t]]]);
										}
										var m = parseInt(valuedata[j].values[0][rec_ch_int[community[t]]]);
										if (m == 0) {
											cg_rec[u].value = 0;
											cg_rec[u].data = 0;
										}
										else {
											cg_rec[u].value = Math.sqrt(m);
											cg_rec[u].data = m;
										}
										u++;
										x_order++;
									}
									order++;
								}
							}
						}
						//****************颜色设置比例尺（红-蓝）************************
						var maxvalue_color = 0;
						var max_data = 0;
						for (var i = 0; i < count * count; i++) {
							if (cg_rec[i].value > maxvalue_color){
								maxvalue_color = cg_rec[i].value;
							}
							else
								continue;
						}
						
						var scale_color = d3.scale.linear()
							.domain([0, maxvalue_color])
							.range([0, 1]);
						var compute = d3.interpolate(rec_a, rec_b);
						
					//****根据新的社区改变矩阵的颜色*******
					
				
						var cards = svg_rec.selectAll(".hour")
						.data(cg_rec);
	
						cards.enter().append("rect")
							.attr("x", function (d) { return (d.x_order -1) * gridSize+4; })
							.attr("y", function (d) { return (d.y_order ) * gridSize+2; })
							.attr("rx", 4)
							.attr("ry", 4)
							.attr("class", "hour bordered")
							.attr("width", gridSize)
							.attr("height", gridSize)
							.attr("id", function(d, i){
								return "rec_" + d.source+"_"+d.target;
							})
							.style("fill", '#ffffd9')
							.transition().duration(1000)
							.style("fill", function (d) { return compute(scale_color(d.value)); });


						d3.select("#tooltip_line").remove();
						var tooltip_line = d3.select("body")
							.append("div")
							.attr("class", "tooltip_line")
							.attr("id","tooltip_line")
							.style("opacity", 0.0);
									
						d3.select("#tooltip_row").remove();
						var tooltip_row = d3.select("body")
							.append("div")
							.attr("class", "tooltip_row")
							.attr("id","tooltip_row")
							.style("opacity", 0.0);

						var rec = svg_rec.selectAll("rect")
							.on("mouseover", function (d, i){
								tooltip_line.html(d.s_dpt)
									.style("left", function(){
										if(d3.event.pageX > 1015)
											return 680 + "px";
										else
											return 1240+"px";
									})
									.style("top", d3.event.pageY + "px")
									.style("opacity", "1.0")

								tooltip_row.html(d.t_dpt)
									.style("left",d3.event.pageX  + "px")
									.style("top", function(){
										if(d3.event.pageY > 315)
											return 40 + "px";
										else
											return 610+"px";
									})
									.style("opacity", "1.0")
								for(var j = 0;j< 17;j++)
								{
									d3.select("#node_out"+j).style("opacity",'0.2');
									d3.select("#node_orginal_"+j).style("opacity",'0.2');
								}
								d3.select("#node_out"+d.source).style("opacity",'1.0');
								d3.select("#node_orginal_"+d.source).style("opacity",'1.0');
								d3.select("#node_out"+d.target).style("opacity",'1.0');
								d3.select("#node_orginal_"+d.target).style("opacity",'1.0');
								for (var j = 0; j < 17; j++) {
									for (var n = 0; n < 17; n++) {
										if ((j == d.source && n == d.target))
										{
											d3.select("#curve_line_"+d.source+"_"+d.target).attr("opacity",1);
											d3.select("#link" + (d.source) + "to" + (d.target)).attr("opacity", "1.0");
											d3.select("#link" + (d.target) + "to" + (d.source)).attr("opacity", "1.0");
										}
										else
										{
											d3.select("#link" + (j) + "to" + (n)).attr("opacity", "0.2");
											d3.select("#curve_line_"+j+"_"+n).attr("opacity",0);
										}
									}
								}
							})
							.on("mousemove", function (d,i) {
								tooltip_line.style("left",function(){
									if(d3.event.pageX > 1015)
										return 680 + "px";
									else
										return 1240 + "px"
								})
									.style("top",(d3.event.pageY-20) + "px")
									.style("opacity", "1.0")


								tooltip_row.style("left",d3.event.pageX  + "px")
									.style("top", function(){
										if(d3.event.pageY > 315)
											return 40 + "px";
										else
											return 620+"px"; 
									})
									.style("opacity", "1.0")


								d3.select("#curve_line_"+d.source+"_"+d.target)
									.attr("opacity",1);
								for(var y = 1; y <= 7;y++)
								{
									$("#"+y+"-1").text(d[y]);
									$("#"+y+"-2").text(d[y+7]);
									$("#"+y+"-3").text("("+d.s_dpt+","+d.t_dpt+")");
								}
								for (var j = 0; j < 17; j++) {
									for (var n = 0; n < 17; n++) {
										if ((j == d.source && n == d.target)||(n == d.source && j == d.target))
										{
											d3.select("#link" + (d.source) + "to" + (d.target)).attr("opacity", "1.0");
											d3.select("#link" + (d.target) + "to" + (d.source)).attr("opacity", "1.0");
										}
										else
											d3.select("#link" + (j) + "to" + (n)).attr("opacity", "0.1");
									}
								}
								$("#dept_name").val(d.data);
							});


						d3.select("#focusLineX").remove();
						d3.select("#focusLineY").remove();
						var cross_g = svg_rec.append('g')
						var focus = cross_g.append('g').style("display",'none')
						focus.append('line')
							.attr('id', 'focusLineX')
							.attr('class', 'focusLine');
						focus.append('line')
							.attr('id', 'focusLineY')
							.attr('class', 'focusLine');
						
						svg_rec.on("mouseover", function (d, i) {
										focus.style('display', null);
										focus.select('#focusLineX')
											.attr("opacity",1)
											
										focus.select('#focusLineY')
											.attr("opacity",1)
									})
									.on("mousemove", function (d, i){
										var mouse = d3.mouse(this);
										var cur_x = mouse[0];
										var cur_y = mouse[1];
										focus.style('display',null);
										focus.select('#focusLineX')
											.attr("opacity","1")
											.attr('x1', cur_x - 650).attr('y1',cur_y)
											.attr('x2', cur_x+650).attr('y2', cur_y);
										focus.select('#focusLineY')
											.attr("opacity","1")
											.attr('x1', cur_x).attr('y1', cur_y+650)
											.attr('x2', cur_x).attr('y2', cur_y-650);
									})
									.on("mouseout", function(d){
										focus.select('#focusLineX')
											.attr("opacity","0.0")
											
										focus.select('#focusLineY')
											.attr("opacity","0.0")
									});
						
						

					}
					//***********************画时序矩阵图函数************************

					function draw_rec_time(nodes, community_assignment_result_1, ALL_DATA) {
						svg_rec.selectAll("path").remove();
						svg_rec.selectAll("circle").remove();
						svg_rec.selectAll("line").remove();
						
							bg_color(community_assignment_result_1,nodes);

							function getInOutData(data) {
								var count = 0;
								data.forEach(function (d) {
									count += 1;
								});

								var nodes_here = {};
								var nodes_here = data;
								var in_out_data = [];
								for (var i = 0; i < count; i++) {
									nodes_here[i].index = i;
								}

								var ch_int = {};
								for (var i = 0; i < count; i++) {
									ch_int[i] = nodes_here[i]['industry'];
								}
								for (var i = 0; i < count; i++) {
									var temp_in_out = [];
									for (var j = 0; j < count; j++) {
										temp_in_out.push(parseInt(nodes_here[i][ch_int[j]]));
									}
									in_out_data.push(temp_in_out);
								}
								return in_out_data;
							}

							var All_in_out = [];
							for(var i = 0; i< 7;i++)
							{
								All_in_out.push(getInOutData(ALL_DATA[i]));
							}

						//************位置处理**************

							var max_com = 0;
								for (var i = 0; i < count; i++) {
									if (max_com < community_assignment_result_1[i])
										max_com = community_assignment_result_1[i];
								}
								var community = [];
								var c = 0;
								var community_1 = [];
								for (var i = 0; i <= max_com; i++) {
									for (var j = 0; j < count; j++) {
										if (community_assignment_result_1[j] == i) {
											community[c] = j;
											community_1[c] = i;
											c++;
										}
									}
								}
								
								//console.log("community: ",community);
								var cg_rec = [];
								var u = 0;
								var order = 0;
								for (var i = 0; i <= max_com; i++) {
									for (var j = 0; j < count; j++) {
										var x_order = 0;
										if (nodes[j].community == i) {
											for (var t = 0; t < count; t++) {
												cg_rec[u] = {};
												cg_rec[u].x_order = x_order + 1;
												cg_rec[u].y_order = order;
												cg_rec[u].s_com = i ;
												cg_rec[u].t_com = community_1[t];
												cg_rec[u].source = j;
												cg_rec[u].target = community[t];
												u++;
												x_order++;
											}
											order++;
										}
									}
								}
								//console.log("时序矩阵图的数据： ",cg_rec);

								var x_order_arr = [];
								x_order_arr.push(0);
								for(var i = 0; i<= max_com;i++){
									var x_order = 0;
									for(var j = 0; j< 17;j++){
										if(cg_rec[j].t_com == i)
										{
											x_order = cg_rec[j].x_order;
										}
									}
									x_order_arr.push(x_order);
								}
								//console.log(x_order_arr);
								var line_arr = [];
								for(var i = 1; i<x_order_arr.length;i++)
								{
									var point_1 = [x_order_arr[i - 1]*gridSize+4, (x_order_arr[i - 1] )*gridSize+2];
									var point_2 = [x_order_arr[i]*gridSize+4, (x_order_arr[i - 1])*gridSize+2];
									var point_3 = [x_order_arr[i - 1]*gridSize+4, (x_order_arr[i])*gridSize+2];
									var point_4 = [x_order_arr[i]*gridSize+4,  (x_order_arr[i])*gridSize+2	];
									line_arr.push([[point_1[0]-2.5,point_1[1]],[point_2[0]+2.5,point_2[1]]]);
									line_arr.push([point_1,point_3]);
									line_arr.push([point_2,point_4]);
									line_arr.push([[point_3[0]-2.5,point_3[1]],[point_4[0]+2.5,point_4[1]]]);
								}
								for(var i = 0; i<line_arr.length;i++)
								{
									svg_rec.append('line')
											.attr('x1', line_arr[i][0][0])
											.attr('y1', line_arr[i][0][1])
											.attr('x2', line_arr[i][1][0])
											.attr('y2', line_arr[i][1][1])
											.style("stroke",color_com(parseInt(i/4)))
											.style("stroke-width",5)
											.attr("id","com_line_"+parseInt(i/4));
								}
								
								////console.log(rec_in_all_value);  //各个部门流年数据值和
								var count_rec_in = 0;
			
								for(var i = 0; i< count*count;i++)
								{
									var cur_max = 0;
									var cur_data_arr = [];
									var real_data = []
									var a = cg_rec[i].source;
									var	b = cg_rec[i].target;
									for (var s = 0; s < 7; s++) {
										cur_data_arr.push(Math.sqrt(All_in_out[s][a][b]));
										real_data.push(All_in_out[s][a][b]);
										if(cur_max < All_in_out[s][a][b])
											cur_max = All_in_out[s][a][b];
									}
									cur_max = Math.sqrt(cur_max);
										//横坐标轴比例尺
										var n = cg_rec[i].x_order - 1;
										var m = cg_rec[i].y_order;
										var xScale = d3.scale.linear()
										.domain([0,7])
										.range([(n)* gridSize + (gridSize/8)+4,(n)* gridSize+ 7 * (gridSize / 8)+8]);//这个range相当于横轴的左右平移
										
										//纵坐标轴比例尺
										var yScale = d3.scale.linear()
										.domain([0,cur_max])
										.range([(m+1)*gridSize - (gridSize/8)+4,(m) * gridSize+(gridSize/8)+4 ]);
										
										//添加折线
										var line = d3.line()
										.x(function(d,i){return xScale(i);})
										.y(function(d){return yScale(d);})
										.curve(d3.curveCardinal);
										var path = svg_rec.append("path")
										.attr("d", line(cur_data_arr))
										.style("fill","none")
										.style("stroke-width",1)
										.style("stroke",rec_curve)
										.style("stroke-opacity",0.9)
										.attr("id","rec_line_"+a+"_"+b);
										
										//添加系列的小圆点
										svg_rec.selectAll("a")
										.data(cur_data_arr)
										.enter()
										.append("circle")
										.attr("cx", function(d,i) {
										return xScale(i);
										})
										.attr("cy", function(d) {
										return yScale(d);
										})
										.attr("r",0.6)
										.attr("fill",rec_curve)
										.attr("id","rec_circle_"+a+"_"+b);
								}
								svg_rec.selectAll("circle")
										.on("click",function(d,i){
											var year_arr = ["1997","2000","2002","2005","2007","2010","2012"];
											var index = i%7;
											//改变年份下拉框的值
											document.querySelector("#selectdata").value = year_arr[index];
											//改变当前年份的值
											var cur_community_result = [];
											$("#cur_year").val(year_arr[index]);
											$("#cur_year_rec").val(year_arr[index]);
											for(var t = 0;t <count;t++)
											{
												ALL_DATA[index][t].community = 0;
												cur_community_result[t] = 0;
											}
											$("#k1_value").val(0);
											slider_k1(ALL_DATA[index],ALL_DATA_1[index],0,0.000001);

											$("#k2_value").val(1);
											slider_k2(ALL_DATA[index],ALL_DATA_1[index],0,0.000001);

											$("#amount").val(0);
											slider_MIN(ALL_DATA[index],ALL_DATA_1[index],0,0.0000001);
											bg_color(cur_community_result,ALL_DATA[index]);
											draw_rec_time(ALL_DATA[index], cur_community_result, ALL_DATA);
											draw_force(ALL_DATA_1[index],ALL_DATA[index],0.00000001);
										});
								var zoom = d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoomed);
								function zoomed() {
									svg_rec.attr("transform",
										"translate(" + zoom.translate() + ")" +
										"scale(" + zoom.scale() + ")"
									);
								}
								svg_rec.call(zoom);

								function interpolateZoom(translate, scale) {
									var self = this;
									return d3.transition().duration(350).tween("zoom", function () {
										var iTranslate = d3.interpolate(zoom.translate(), translate),
											iScale = d3.interpolate(zoom.scale(), scale);
										return function (t) {
											zoom.scale(iScale(t))
												.translate(iTranslate(t));
											zoomed();
										};
									});
								}
						}

	//*********************力引导图相关数据处理****************************

						var nodes = {};
						var nodes = data;
						var nodes_coe = data_1;
//****************************初始化状态图************************************

						draw_rec_time(nodes, community_assignment_result_1, ALL_DATA);

						$("#k1_value").val(0);
						slider_k1(nodes,nodes_coe,0,0.00001);

						$("#k2_value").val(1);
						slider_k2(nodes,nodes_coe,0,0.00001);

						$("#amount").val(0);
						slider_MIN(nodes,nodes_coe,0,0.00001);

						draw_force(nodes_coe,nodes, 0.00000001);

						d3.select("#sankey").selectAll("svg").remove();
						draw_sankey( 0.00000001,0);
						function draw_force(nodes_coe, nodes, cur_min){
							//console.log("nodes_coe: ",nodes_coe);
							svg_force.selectAll("text").remove();

									$("#reset-opacity").on("click",function(){
										
										for(var i = 0; i< count;i++){
											for(var j = 0; j < count;j++)
											{
												d3.select("#link"+i+"to"+j)
													.attr("opacity", "0.5");
												d3.select("#curve_line_"+i+"_"+j)
													.attr("opacity",0);
											}
										}
										for(var j = 0; j < count;j++){
											d3.select("#node_orginal_"+j).style("opacity","1.0");
										}
										for(var j = 0; j < count;j++){
											d3.select("#node_out"+j).style("opacity","1.0");
										}
									})
									$("#reset-opacity-rec").on("click",function(){
												d3.select("#tooltip_row").style("opacity","0");
												d3.select("#tooltip_line").style("opacity","0");
													for(var i = 0; i< count;i++){
														for(var j = 0; j < count;j++)
														{
															d3.select("#curve_line_"+i+"_"+j)
																.attr("opacity",0);
														}
													}
													for(var s = 0; s < 17;s++){
														for(var t = 0 ;t < 17 ;t++){
															d3.select("#rec_"+s+"_"+t).style("opacity","1.0");
															d3.selectAll("#rec_circle_"+s+"_"+t).style("opacity","1.0");
															d3.select("#rec_line_"+s+"_"+t).style("opacity","1.0");
														}
													}
													for(var i = 0; i <10;i++){
														d3.selectAll("#com_line_"+i).style("opacity","1.0");
													}
									});
									for (var i = 0; i < count; i++) {
										nodes[i].index = i;
									}
									//文字转数字数组
									var ch_int = {};
									for (var i = 0; i < count; i++) {
										ch_int[i] = nodes[i]['industry'];
									}
									
									//给nodes添加总流入、总流出、及其和的属性
									for (var i = 0; i < count; i++){
										var temp_in = 0;
										var temp_out = 0;
										for (var j = 0; j < count; j++) {
											temp_in += parseInt(nodes[j][ch_int[i]]);
											temp_out += parseInt(nodes[i][ch_int[j]]);
											if (parseInt(nodes[i][ch_int[j]]) >= 0)
												continue;
											else {
											}
										}
										nodes[i]['all_in'] = temp_in;
										nodes[i]['all_out'] = temp_out;
									}
									//取出all_in、all_out、all
									var data_all = [];

									data_all[0] = [];
									data_all[1] = [];
									data_all[2] = [];
									for (var j = 0; j < count; j++) {
										data_all[0][j] = parseInt(nodes[j]['all_in']);
										data_all[1][j] = parseInt(nodes[j]['all_out']);
									}
									//求最大值
									function max(data_all, m) {
										var maxvalue = 0;
										for (var i = 0; i < count; i++) {
											if (data_all[m][i] > maxvalue) {
												maxvalue = data_all[m][i];
											}
										}
										return maxvalue;
									}
									//最大半径值
									var maxvalue_r_in = max(data_all, 0);
									var maxvalue_r_out = max(data_all, 1);
									var maxvalue_r = Math.max(maxvalue_r_in,maxvalue_r_out);
									//最大颜色值
									var maxvalue_color = max(data_all, 1);
									//最大宽度值
									var data_in = [];
									var x = 0;
									for (var i = 0; i < count; i++) {
										for (var j = i + 1; j < count; j++) {
											data_in[x] = parseInt(nodes[i][ch_int[j]]);
											x++;
										}
									}

									var maxvalue_width = 0;
									for (var i = 0; i < count; i++) {
										if (data_in[i] > maxvalue_width)
											maxvalue_width = data_in[i];
										else
											continue;
									}
									//半径设置比例尺
									var scale_r = d3.scale.linear()
										.domain([0, maxvalue_r])
										.range([15, 35]);
									//颜色设置比例尺（红-蓝）
									var scale_color = d3.scale.linear()
										.domain([0, maxvalue_color])
										.range([0, 1]);
									var compute = d3.interpolate(circle_a, circle_b);
									//画Colorbar
									var defs = svg_rec.append("defs");  
									var linearGradient = defs.append("linearGradient")  
															.attr("id","linearColor")  
															.attr("x1","0%")  
															.attr("y1","0%")  
															.attr("x2","100%")  
															.attr("y2","0%");  
									var stop1 = linearGradient.append("stop")  
													.attr("offset","0%")  
													.style("stop-color",circle_a.toString());  
									var stop2 = linearGradient.append("stop")  
													.attr("offset","100%")  
													.style("stop-color",circle_b.toString());
									var colorRect = svg_force.append("rect")  
										.attr("x", 490)  
										.attr("y", 610)  
										.attr("width", 200)  
										.attr("height", 15)  
										.style("fill","url(#" + linearGradient.attr("id") + ")"); 
									
									
									var defs_text_min  = svg_force.append("text")
															.attr("font-size",12)
															.attr("x",425)
															.attr("y",620)
															.text("渐变颜色条");
									//设置nodes的半径和颜色
									//流入大与流出蓝色
									
									for (var i = 0; i < count; i++){
										temp_r_in = scale_r(parseInt(nodes[i]['all_in']));
										temp_r_out = scale_r(parseInt(nodes[i]['all_out']));
										temp_color = scale_color(parseInt(nodes[i]['all_out']));
										if(temp_r_in > temp_r_out){
											nodes[i].r_s = temp_r_out;
											nodes[i].b = temp_r_in;
											nodes[i].out_color = in_out;
										}
										else{
											nodes[i].r_s = temp_r_in;
											nodes[i].b = temp_r_out;
											nodes[i].out_color = out_in;
										}
										nodes[i].color = temp_color;
									}
									
									//宽度设置比例尺
									var scale_width = d3.scale.linear()
										.domain([0, maxvalue_width])
										.range([1, 25]);
									var scale_distance = d3.scale.linear()
										.domain([0, maxvalue_width])
										.range([0, 200]);
									
									svg_force.selectAll("g").remove();
									svg_force.selectAll("line").remove();
									svg_force.selectAll("path").remove();

									
										//************上面是draw点的函数********************************
										var node_1 = [];
										for (var i = 0; i < count; i++) {
											node_1[i] = i;
										}
										var links = [];
										var k = 0;
										for (var i = 0; i < count; i++) {
											for (var j = i + 1; j < count; j++) {
												var temp_0 = scale_width(parseInt(nodes[i][ch_int[j]]));
												if (temp_0 > 0) {
													links[k] = {};
													links[k].source = nodes[i];
													links[k].target = nodes[j];
													links[k].s = i;
													links[k].t = j;
													links[k].width_cal = temp_0;
													links[k].in_width = 0;
													links[k].width = temp_0;
													links[k].in = 0;
													links[k].add = 0;
													links[k].value = scale_distance(parseInt(nodes[i][ch_int[j]]));
													k++;

												}
												else
													continue;
												var temp_1 = scale_width(parseInt(nodes[j][ch_int[i]]));
												if (temp_1 > 0){
													links[k] = {};
													links[k].source = nodes[j];
													links[k].s = j;
													links[k].t = i;
													links[k].target = nodes[i];
													links[k].width = temp_1;
													links[k].width_cal = temp_1;
													links[k].in = 1;
													//确定点之间的距离
													links[k].value = scale_distance(parseInt(nodes[j][ch_int[i]]));
													if (temp_0 > 0) {
														links[k].in_width = temp_0;
														links[k].add = 1;
													}
													else {
														links[k].in_width = 0;
														links[k].add = 2;
													}
													k++;
												}
												else
													continue;
											}
										}
						//*************方向线函数******************
						
								function get_curve_line(links,nodes){

									function cal_add_x(x1, x2, y1, y2, width) {
										t = (y1 - y2) / (x1 - x2);
										var add_x = (Math.abs(t) * (width / 2)) / (Math.sqrt((Math.abs(t * t) + 1)));
										if ((x1 - x2) < 0 && (y1 - y2) < 0 || (x1 - x2) > 0 && (y1 - y2) < 0) {
											return add_x;
										}
										else if ((x1 - x2) < 0 && (y1 - y2) > 0 || (x1 - x2) > 0 && (y1 - y2) > 0) {
											return -add_x;
										}
									}
									function cal_add_y(x1, x2, y1, y2, width) {
										t = (y1 - y2) / (x1 - x2);
										var add_y = (width / 2) / (Math.sqrt((Math.abs(t * t) + 1)));
										if ((x1 - x2) < 0 && (y1 - y2) < 0 || (x1 - x2) < 0 && (y1 - y2) > 0) {
											return -add_y;
										}
										else if ((x1 - x2) > 0 && (y1 - y2) < 0 || (x1 - x2) > 0 && (y1 - y2) > 0)
											return add_y;
									}

									var curve_line = [];
									for(var i = 0; i< links.length;i++)
									{
										var temp_curve = [];
										//流出线（坐标就是点的坐标）
										if(links[i].add == 0)
										{
											var s_x_1 = nodes[links[i].s].x; 
											var s_y_1 = nodes[links[i].s].y;
											var t_x_1 = nodes[links[i].t].x; 
											var t_y_1 = nodes[links[i].t].y; 

											var t_y = t_y_1 + (s_y_1 - t_y_1)/3;
											var s_x = s_x_1 - (s_x_1 - t_x_1)/3;
											var t_x = t_x_1 + (s_x_1 - t_x_1)/3;
											var s_y = s_y_1 - (s_y_1 - t_y_1)/3;


											var x_1 = s_x + cal_add_x(s_x, t_x, s_y, t_y, links[i].width+30);
											var y_1 = s_y + cal_add_y(s_x, t_x, s_y, t_y, links[i].width+30);

											var x_2 = t_x + cal_add_x(s_x, t_x, s_y, t_y, links[i].width+30);
											var y_2 = t_y + cal_add_y(s_x, t_x, s_y, t_y, links[i].width+30);
											var cur_point_1 = {}
											cur_point_1.x = x_1;
											cur_point_1.y = y_1;
											cur_point_1.s = links[i].s;
											cur_point_1.t  = links[i].t;
											var cur_point_2 = {};
											cur_point_2.x = x_2;
											cur_point_2.y = y_2;
											cur_point_2.s = links[i].s;
											cur_point_2.t = links[i].t;

											temp_curve.push([cur_point_1, cur_point_2]);
										}
										else if(links[i].add == 1){
											var s_x_1 = nodes[links[i].s].x; 
											var s_y_1 = nodes[links[i].s].y;
											var t_x_1 = nodes[links[i].t].x; 
											var t_y_1 = nodes[links[i].t].y; 

											var t_y = t_y_1 + (s_y_1 - t_y_1)/3;
											var s_x = s_x_1 - (s_x_1 - t_x_1)/3;
											var t_x = t_x_1 + (s_x_1 - t_x_1)/3;
											var s_y = s_y_1 - (s_y_1 - t_y_1)/3;

											var x_1 = s_x + cal_add_x(s_x, t_x, s_y, t_y, links[i].in_width+30);
											var y_1 = s_y + cal_add_y(s_x, t_x, s_y, t_y, links[i].in_width+30);

											var x_2 = t_x + cal_add_x(s_x, t_x, s_y, t_y, links[i].in_width+30);
											var y_2 = t_y + cal_add_y(s_x, t_x, s_y, t_y, links[i].in_width+30);
											var cur_point_1 = {}
											cur_point_1.x = x_1;
											cur_point_1.y = y_1;
											cur_point_1.s = links[i].s;
											cur_point_1.t  = links[i].t;
											var cur_point_2 = {};
											cur_point_2.x = x_2;
											cur_point_2.y = y_2;
											cur_point_2.s = links[i].s;
											cur_point_2.t = links[i].t;

											temp_curve.push([cur_point_1, cur_point_2]);
										}
										curve_line.push(temp_curve);
									}
									return curve_line;
								}
								
								var cur_max_com = 0;
								for(var i = 0 ;i< count;i++)
								{
									if(cur_max_com < nodes[i]["community"])
										cur_max_com = nodes[i]["community"];
								}
								if(cur_max_com == 0)
								{
									var simulation = d3.forceSimulation()
									.force("link", d3.forceLink().id(function(d) { return d.id; }).distance(function(d){return 300 - d.value;}))  //创建连接力
									.force("charge", d3.forceManyBody().strength(-800).distanceMin(100))			//创建多体力
									.force("center", d3.forceCenter(width / 2, height / 2));	//创建力的中心
								}
								else{
									var simulation = d3.forceSimulation()
									.force("link", d3.forceLink().id(function(d) { return d.id; }).distance(function(d){
										if(d.source.community == d.target.community)
											return 80 - d.value;
										else if(d.source.community != d.target.community)
										 	return 300 - d.value; 
									}))  //创建连接力
									.force("charge", d3.forceManyBody().strength(-800).distanceMin(100))			//创建多体力
									.force("center", d3.forceCenter(width / 2, height / 2));	//创建力的中心
								}
								
									
								//***********************画线*************
									var link = svg_force.append("g")
										.selectAll("line")
										.data(links)
										.enter().append("line")
										.attr("id", function (d, i) {
											return "link" + (d.source.index) + "to" + (d.target.index);
										})
										.attr("stroke", function (d, i) {
											if (d.in == 0)
												return in_c ;
											else if (d.in == 1)
												return out_c;
										})
										.attr("opacity", "0.4")
										.attr("stroke-width", function (d) { return d.width; });
										

									
									function ticked_line() {
										link.attr("x1", function (d, i) {
												if (d.add == 1) {
													return d.source.x + cal_add_x(d.source.x, d.target.x, d.source.y, d.target.y, d.in_width + d.width);
												}
												else {
													return d.source.x;
												}
											})
											.attr("y1", function (d, i) {
												if (d.add == 1) {
													return d.source.y + cal_add_y(d.source.x, d.target.x, d.source.y, d.target.y, d.in_width + d.width);
												}
												else {
													return d.source.y;
												}
											})
											.attr("x2", function (d, i) {
												if (d.add == 1) {
													return d.target.x + cal_add_x(d.source.x, d.target.x, d.source.y, d.target.y, d.in_width + d.width);
												}
												else {
													return d.target.x;
												}
											})
											.attr("y2", function (d, i) {
												if (d.add == 1) {
													return d.target.y + cal_add_y(d.source.x, d.target.x, d.source.y, d.target.y, d.in_width + d.width);
												}
												else {
													return d.target.y;
												}
											});
										node.attr("cx", function (d) { return d.x; })
											.attr("cy", function (d) { return d.y; });
										for(var i =0 ;i< count;i++){
											d3.select("#node_out"+i).attr("transform", "translate(" + nodes[i].x + "," + nodes[i].y + ")")
										}
										
										var curve_lines = get_curve_line(links,nodes);
										var line_basis = d3.line()
													.x(function(d){return d.x;})
													.y(function(d){return d.y;})
													.curve(d3.curveBasis);
													
										for(var l = 0;l<curve_lines.length;l++){
											for(var c = 0; c < curve_lines[l].length;c++){
												d3.select("#curve_line_" + curve_lines[l][c][0].s+"_"+curve_lines[l][c][0].t).attr('d',line_basis(curve_lines[l][c]))
												.style("fill","none");
											}
										}
									}
									//*********画方向线*************
									
									var curve_lines = get_curve_line(links,nodes);
									//console.log(curve_lines);
									d3.select("#arrow").remove();
									var defs = svg_force.append("defs");
									var arrowMarker = defs.append("marker")
										.attr("id","arrow")
										.attr("markerUnits","strokeWidth")
										.attr("markerWidth","12")
										.attr("markerHeight","12")
										.attr("viewBox","0 0 12 12")
										.attr("refX","6")
										.attr("refY","6")
										.attr("orient","auto")
										.append("path")
										.attr("d","M2,2 L10,6 L2,10 L6,6 L2,2")
										.attr("fill","#000000");  

									var line_basis = d3.line()
												.x(function(d){return d.x;})
												.y(function(d){return d.y;})
												.curve(d3.curveBasis);
									for(var l = 0;l<curve_lines.length;l++)
									{
										for(var c = 0; c < curve_lines[l].length;c++)
										{
											svg_force.append("path")
												.attr("d",line_basis(curve_lines[l][c]))
												.attr("stroke","black")
												.attr("stroke-width",2)
												.attr("opacity",0)
												.attr("fill","none")
												.attr("id",function(){
													return "curve_line_" + curve_lines[l][c][0].s+"_"+curve_lines[l][c][0].t;
												})
												.attr("marker-end","url(#arrow)"); 
										}
									}
									//设置力的模拟节点
									simulation
										.nodes(nodes)
										.on("tick", ticked_line);
								
									//添加或移除力
									simulation.force("link")
										.links(links);
									//*********************画点***********************
									d3.select("#tooltip_1").remove();
									var tooltip = d3.select("body")
										.append("div")
										.attr("id","tooltip_1")
										.attr("class", "tooltip")
										.style("opacity", 0.0)
										.style("width", "100px");

									var node = svg_force.append("g")
										.attr("class", "nodes")
										.selectAll("circle")
										.data(nodes)
										.enter().append("circle")
										.attr("r", function(d){
											return d.r_s;
										})
										.attr("fill", function (d) { return compute(d.color); })
										.attr("id", function (d,i) {
											return "node_orginal_"+i;
										})
										.call(d3.drag()
											.on("start", dragstarted)
											.on("drag", dragged)
											.on("end", dragended));

								//********画随点移动的圆环********

									var pie = d3.layout.pie()
										.value(function (d) {
											return d;
										});
									var piedata = pie(nodes);
										for(var i = 0 ; i < count ;i++)
										{
											piedata[i].startAngle = 0;
											piedata[i].endAngle = 360;
											var arc = d3.svg.arc()
												.innerRadius(function(d){
													return d.data.r_s;
												})
												.outerRadius(function(d){
													return d.data.b;
												});
											
											svg_force.append("path")
														.attr("fill", function () {
															return piedata[i].data.out_color;
														})
														.attr("d", arc(piedata[i]))
														.attr("transform", "translate(" + nodes[i].x + "," + nodes[i].y + ")")
														.attr("id", function () {
															return "node_out" + i;
														});
										}

								//*********画左下角固定的圆环********

										var pie = d3.layout.pie()
												.value(function (d) {
													return d;
												});
										var r_or_g = ["red","green"];
										var pie_r_or_g = pie(r_or_g);
										for(var i = 0; i< 2; i++)
										{
											pie_r_or_g[i].startAngle = 0;
											pie_r_or_g[i].endAngle = 360;
											var arc_1 = d3.svg.arc()
												.innerRadius(5)
												.outerRadius(10);
											svg_force.append("path")
													.attr("fill", function () {
														if(i == 0)
															return in_out;
														else
															return out_in;
													})
													.attr("d", arc_1(pie_r_or_g[i]))
													.attr("transform", "translate(" + 15 + "," + (i*25+580) + ")")
													.attr("id", r_or_g[i]);
											
										}
								//*********画固定不动的两条提示直线**********
									var fixed_line = d3.svg.line()
										.x(function(d){
											return d[0];})
										.y(function(d){return d[1];});

										var fx_line = [[[5,550],[40,550]],[[45,550],[80,550]]];
										for(var i = 0 ;i < 2;i++){
											svg_force.append("path")
												.attr("d",fixed_line(fx_line[i]))
												.style("stroke-width",7)
												.style("stroke",function(){
													if(i == 0)
														return "#007651";
													else
														return "#895e00";
												})
												.style("stroke-opacity",0.9)
												.attr("id", "fixed_line_"+(i+1));
										}
										
								//***********添加圆环和直线文字**********
										var text_arr = ["","流量线","总流入 > 总流出","总流入 < 总流出"]
										svg_force.selectAll("text")
												.data(text_arr)
												.enter()
												.append("text")
												.attr("x",function(d,i){
													if(i == 1)
														return 85;
													else
														return 35;
												})
												.attr("y",function(d,i){
													if(i == 1)
														return 555;
													else 
														return (i - 2)*25+583;
												})
												.style("font-size","12px")
												.text(function(d,i){
													return d;
												})
										//圆环的tooltip
										svg_force.selectAll("circle")
											.on("mouseover", function (d, i) {
												var str_1 = d.industry + ": ";
												var str_2 = "in：" + d.all_in + " ";
												var str_3 = "out： " + d.all_out;
												tooltip.html(str_1 + str_2 + str_3)
													.style("left", (d3.event.pageX) + "px")
													.style("top", (d3.event.pageY + 10) + "px")
													.style("width", "150px")
													.style("opacity", 1.0)
													.style("background-color", "#F4F4F4");
											})
											.on("mousemove", function (d, i) {
												tooltip.style("left", (d3.event.pageX) + "px")
													.style("top", (d3.event.pageY + 10) + "px")
													.style("background-color", "#F4F4F4");
											})
											.on("mouseout", function (d) {
												tooltip.style("opacity", 0.0)
											});

										//*****************************坐标变换*********************
										function cal_add_x(x1, x2, y1, y2, width) {
											t = (y1 - y2) / (x1 - x2);
											var add_x = (Math.abs(t) * (width / 2)) / (Math.sqrt((Math.abs(t * t) + 1)));
											if ((x1 - x2) < 0 && (y1 - y2) < 0 || (x1 - x2) > 0 && (y1 - y2) < 0) {
												return add_x;
											}
											else if ((x1 - x2) < 0 && (y1 - y2) > 0 || (x1 - x2) > 0 && (y1 - y2) > 0) {
												return -add_x;
											}
										}
										function cal_add_y(x1, x2, y1, y2, width) {
											t = (y1 - y2) / (x1 - x2);
											var add_y = (width / 2) / (Math.sqrt((Math.abs(t * t) + 1)));
											if ((x1 - x2) < 0 && (y1 - y2) < 0 || (x1 - x2) < 0 && (y1 - y2) > 0) {
												return -add_y;
											}
											else if ((x1 - x2) > 0 && (y1 - y2) < 0 || (x1 - x2) > 0 && (y1 - y2) > 0)
												return add_y;
										}
										function ticked_out() {
											node.attr("cx", function (d) { return d.x; })
												.attr("cy", function (d) { return d.y; });
										}
										function dragstarted(d) {
											if (!d3.event.active) simulation.alphaTarget(0.1).restart();
											d.fx = d.x;
											d.fy = d.y;
										}
										function dragged(d) {
											d.fx = d3.event.x;
											d.fy = d3.event.y;
										}
										function dragended(d) {
											if (!d3.event.active) simulation.alphaTarget(0);
											d.fx = null;
											d.fy = null;
										}
									}


							//**********************获取社区函数***********************	 
							function get_com_btn(community_assignment_result,nodes,nodes_coe,cur_min){
									var original_node_data = d3.entries(nodes);
									var node_ids = Object.keys(community_assignment_result);
									var max_community_number = 0;
									//console.log(community_assignment_result);
									node_ids.forEach(function (d){
										original_node_data[d].community = community_assignment_result[d];
										max_community_number = max_community_number < community_assignment_result[d] ? community_assignment_result[d] : max_community_number;
									});
									for(var i = 0; i < count; i++){
										nodes[i].community = original_node_data[i].community;
									}
								
									
									draw_rec_time(nodes, community_assignment_result, ALL_DATA);
									
									draw_force(nodes_coe,nodes, cur_min);
									svg_force.selectAll('circle')
										.data(nodes)
										.style('fill', function(d){
											return color_com(d.community);
										})
									var circle_com = [];
									var circle_text = [];
									var index = 0;
									while(community_assignment_result[index] != null)
									{
										if(circle_com.indexOf(community_assignment_result[index]) == -1)
										{
											circle_text.push(community_assignment_result[index]);
											circle_com.push(community_assignment_result[index]);
										}
										index++;											
									}
									var com_node_arr = new Array(circle_com.length);
									for(var i = 0; i<com_node_arr.length;i++){
										com_node_arr[i] = [];
									}
									var index = 0;
									while(community_assignment_result[index] != null)
									{
										com_node_arr[community_assignment_result[index]].push(index);
										index++;
									}
									svg_force.append("g")
										.attr("class", "nodes")
										.selectAll("circle")
										.data(circle_com)
										.enter().append("circle")
										.attr("r","6px")
										.attr("fill", function (d) { return color_com(d); })
										.attr("id", function (d) {
											return "circle_com_"+d;
										})
										.attr("cx","10")
										.attr("cy",function(d){
											return d*15+10;
										})
										.on("click",function(d,i){
											for(var j = 0; j<circle_com.length;j++){
												d3.selectAll("#com_line_"+j).style("opacity","0.2")
											}
											d3.selectAll("#com_line_"+i).style("opacity","1.0")
											for(var j = 0; j < count;j++){
												d3.select("#node_orginal_"+j).style("opacity","0.1");
											}
											for(var j = 0; j< com_node_arr[i].length;j++){
												d3.select("#node_orginal_"+com_node_arr[i][j]).style("opacity","1.0");
											}
											for(var j = 0; j < count;j++){
												d3.select("#node_out"+j).style("opacity","0.1");
											}
											for(var j = 0; j< com_node_arr[i].length;j++){
												d3.select("#node_out"+com_node_arr[i][j]).style("opacity","1.0");
											}
											for (var j = 0; j < 16; j++) {
												for (var n = j+1; n < 17; n++) {
													if(com_node_arr[i].indexOf(j) != -1  && com_node_arr[i].indexOf(n) != -1){
														d3.select("#link" + (j) + "to" + (n)).attr("opacity", "0.6");
														d3.select("#link" + (n) + "to" + (j)).attr("opacity", "0.6");
														d3.select("#curve_line_"+j+"_"+n).attr("opacity",0);
													}
													else{
														d3.select("#link" + (j) + "to" + (n)).attr("opacity", "0.1");
														d3.select("#link" + (n) + "to" + (j)).attr("opacity", "0.1");
														d3.select("#curve_line_"+j+"_"+n).attr("opacity",0);
													}
												}
											}
											for(var s = 0; s < 17;s++){
												for(var t = 0 ;t < 17 ;t++){
													if(com_node_arr[i].indexOf(s) != -1 && com_node_arr[i].indexOf(t) != -1){
														d3.select("#rec_"+s+"_"+t).style("opacity","1.0");
														d3.selectAll("#rec_circle_"+s+"_"+t).style("opacity","1.0");
														d3.select("#rec_line_"+s+"_"+t).style("opacity","1.0");
														
													}
													else{
														d3.select("#rec_"+s+"_"+t).style("opacity","0.2");
														d3.selectAll("#rec_circle_"+s+"_"+t).style("opacity","0.2");
														d3.select("#rec_line_"+s+"_"+t).style("opacity","0.1");
													}
												}
											}
										});
										
										

										var pie = d3.layout.pie()
											.value(function (d) {
												return d;
											});
											var r_or_g = ["red","green"];
											var pie_r_or_g = pie(r_or_g);
											for(var i = 0; i< 2; i++)
											{
												pie_r_or_g[i].startAngle = 0;
												pie_r_or_g[i].endAngle = 360;
												var arc_1 = d3.svg.arc()
													.innerRadius(5)
													.outerRadius(10);
												svg_force.append("path")
														.attr("fill", function () {
															if(i == 0)
																return in_out;
															else
																return out_in;
														})
														.attr("d", arc_1(pie_r_or_g[i]))
														.attr("transform", "translate(" + 15 + "," + (i*25+580) + ")")
														.attr("id", r_or_g[i]);
											}
											circle_text.push("流量线");
											circle_text.push("总流入 > 总流出");
											circle_text.push("总流入 < 总流出");
											circle_text.push("渐变颜色条");
											
										
											svg_force.selectAll("text").remove();
											svg_force.selectAll("text")
													.data(circle_text)
													.enter()
													.append("text")
													.attr("x",function(d,i){
														if(i < circle_com.length)
															return 30;
														else if(i == circle_text.length - 1)
															return 425;
														else if(i == circle_com.length)
															return 85;
														else
															return 35; 
													})
													.attr("y",function(d,i){
														if(i < circle_com.length)
															return d*15+15;
														else if(i == circle_com.length)
															return 555;
														else if(i == circle_text.length - 1)
															return 620;
														else
															return (i - circle_com.length - 1)*25+583;
													})
													.style("font-size","12px")
													.text(function(d,i){
														if(i < circle_com.length)
															return "社区 "+(d+1);
														else
															return d;
													})
								}
									function get_community(nodes,nodes_coe,cur_min,k){
										function set_Nodes(nodes){
										var count_here = 0;
										nodes.forEach(function (d){
											count_here += 1;
										});
										var nodes_1 = [];
										for (var i = 0; i < count_here; i++){
											nodes_1[i] = i;
										}
										return nodes_1;
										}

										function set_link(nodes_coe,nodes, set_node,k){
											var count_here = 0;
											nodes.forEach(function (d){
												count_here += 1;
											});
											var ch_int_here = {};
											for (var i = 0; i < count_here; i++){
												ch_int_here[i] = nodes[i]['industry'];
											}
											var k1 = k;
											var k2 = 1 - k1;
											var links_1 = [];
											var m = 0;
											for (var i = 0; i < count_here; i++) {
												for (var j = i + 1; j < count_here; j++) {
													var q1 = parseFloat(nodes_coe[i][ch_int_here[j]]);
													var q2 = parseFloat(nodes_coe[j][ch_int_here[i]]);
													var min_q = Math.min(q1,q2);
													var max_q = Math.max(q1,q2);
													
													var temp_weight = k1*(min_q/max_q) + k2*(q1+q2);
													if (temp_weight > 0) {
														links_1[m] = {};
														links_1[m].source = set_node[i];
														links_1[m].target = set_node[j];
														links_1[m].weight = temp_weight;
														m++;
													}
													else
														continue;
													if (temp_weight > 0) {
														links_1[m] = {};
														links_1[m].source = set_node[j];
														links_1[m].target = set_node[i];
														links_1[m].weight = temp_weight;
														m++;
													}
													else
														continue;
												}
											}
											return links_1;
										}

										var nodes_1 = set_Nodes(nodes);
										var links_1 = set_link(nodes_coe,nodes, nodes_1,k);
										//console.log(links_1);
										var community = jLouvain(cur_min).nodes(nodes_1).edges(links_1);
										var community_assignment_result = community();
										//*****************************************************************
										
										$('#社区发现').on('click', function () {
											get_com_btn(community_assignment_result,nodes,nodes_coe,cur_min);
										});

											

									}
										
									
									function slider_k1(nodes,nodes_coe,k1,cur_value){
										slider_MIN(nodes,nodes_coe,k1,cur_value);
										$("#slider_coe").slider({
											range: "min",
											value: k1*10,
											min: 0,
											max: 10,
											orientation: "horizontal",
											slide: function(event, ui){
												$("#k1_value").val(ui.value/10);
												cur_k = ui.value/10;
												//传入新的k1值，来跟新后面社区发现内权重的值
												$("#amount").val(parseInt(cur_value*10)/10);
												slider_MIN(nodes,nodes_coe,cur_k,cur_value);
												//跟新k2滑块的值
												$("#k2_value").val(parseInt((1-cur_k+0.001)*10)/10);
												slider_k2(nodes,nodes_coe,cur_k,cur_value);
											}
										});
									}
									
									function slider_k2(nodes,nodes_coe,k1,cur_value){
										slider_MIN(nodes,nodes_coe,k1,cur_value);
										$("#slider_coe_2").slider({
											range: "min",
											value: 10 - k1*10,
											min: 0,
											max: 10,
											orientation: "horizontal",
											slide: function(event, ui){
												$("#k2_value").val(ui.value/10);
												cur_k = ui.value/10;
												var k1 = 1-cur_k;
												//传入新的k1值，来跟新后面社区发现内权重的值
												$("#amount").val(parseInt(cur_value*10)/10);
												slider_MIN(nodes,nodes_coe,k1,cur_value);
												//更新k1滑块的值
												$("#k1_value").val(parseInt((k1+0.01)*10)/10);
												slider_k1(nodes,nodes_coe,k1,cur_value);
											}
										});
									}
									function slider_MIN(nodes,nodes_coe,k,cur_value){
										d3.select("#sankey").selectAll("svg").remove();
										draw_sankey(cur_value,k);
										get_community(nodes,nodes_coe,cur_value,k)
										$("#MIN_slider").slider({
											range: "min",
											value: parseInt(cur_value*20),
											min: 0,
											max: 20,
											orientation: "horizontal",
											slide: function(event, ui){
												$("#amount").val(ui.value/20);
												cur_min = ui.value/20 + 0.0000001;
												var community_assignment_result = [];
												for (var i = 0; i < count; i++) {
													community_assignment_result[i] = i;
													nodes[i].community = i;
												}
												d3.select("#sankey").selectAll("svg").remove();
												draw_sankey(cur_min,k);
												get_community(nodes,nodes_coe,cur_min,k);
												$("#k1_value").val(parseInt((k+0.01)*10)/10);
												slider_k1(nodes,nodes_coe,k,cur_min);

												$("#k2_value").val(parseInt((1-k+0.01)*10)/10);
												slider_k2(nodes,nodes_coe,k,cur_min);
											}
										});
									}

									function draw_sankey(cur_min,k){
											function set_Nodes(nodes) {
											var count_here = 0;
											nodes.forEach(function (d) {
												count_here += 1;
											});
											var nodes_1 = [];
											for (var i = 0; i < count_here; i++) {
												nodes_1[i] = i;
											}
											return nodes_1;
											}

											function set_link(nodes_coe,nodes, set_node,k) {
												var count_here = 0;
												nodes.forEach(function (d) {
													count_here += 1;
												});
												var ch_int_here = {};
												for (var i = 0; i < count_here; i++) {
													ch_int_here[i] = nodes[i]['industry'];
												}
												var k1 = k;
												var k2 = 1 - k1;
												var links_1 = [];
												var m = 0;
												for (var i = 0; i < count_here; i++) {
													for (var j = i + 1; j < count_here; j++) {
														var q1 = parseFloat(nodes_coe[i][ch_int_here[j]]);
														var q2 = parseFloat(nodes_coe[j][ch_int_here[i]]);
														var min_q = Math.min(q1,q2);
														var max_q = Math.max(q1,q2);
														
														var temp_weight = k1*(min_q/max_q) + k2*(q1+q2);
														if (temp_weight > 0) {
															links_1[m] = {};
															links_1[m].source = set_node[i];
															links_1[m].target = set_node[j];
															links_1[m].weight = temp_weight;
															m++;
														}
														else
															continue;
														if (temp_weight > 0) {
															links_1[m] = {};
															links_1[m].source = set_node[j];
															links_1[m].target = set_node[i];
															links_1[m].weight = temp_weight;
															m++;
														}
														else
															continue;
													}
												}
												return links_1;
											}
											var nodes_1997 = set_Nodes(ALL_DATA[0]);
											var nodes_2000 = set_Nodes(ALL_DATA[1]);
											var nodes_2002 = set_Nodes(ALL_DATA[2]);
											var nodes_2005 = set_Nodes(ALL_DATA[3]);
											var nodes_2007 = set_Nodes(ALL_DATA[4]);
											var nodes_2010 = set_Nodes(ALL_DATA[5]);
											var nodes_2012 = set_Nodes(ALL_DATA[6]);

											var links_1997 = set_link(data_1997_1,data_1997, nodes_1997,k);
											var links_2000 = set_link(data_2000_1,data_2000, nodes_2000,k);
											var links_2002 = set_link(data_2002_1,data_2002, nodes_2002,k);
											var links_2005 = set_link(data_2005_1,data_2005, nodes_2005,k);
											var links_2007 = set_link(data_2007_1,data_2007, nodes_2007,k);
											var links_2010 = set_link(data_2010_1,data_2010, nodes_2010,k);
											var links_2012 = set_link(data_2012_1,data_2012, nodes_2012,k);

											var community_1997 = jLouvain(cur_min).nodes(nodes_1997).edges(links_1997);
											var community_2000 = jLouvain(cur_min).nodes(nodes_2000).edges(links_2000);
											var community_2002 = jLouvain(cur_min).nodes(nodes_2002).edges(links_2002);
											var community_2005 = jLouvain(cur_min).nodes(nodes_2005).edges(links_2005);
											var community_2007 = jLouvain(cur_min).nodes(nodes_2007).edges(links_2007);
											var community_2010 = jLouvain(cur_min).nodes(nodes_2010).edges(links_2010);
											var community_2012 = jLouvain(cur_min).nodes(nodes_2012).edges(links_2012);

											var community_assignment_result_1997 = community_1997();
											var community_assignment_result_2000 = community_2000();
											var community_assignment_result_2002 = community_2002();
											var community_assignment_result_2005 = community_2005();
											var community_assignment_result_2007 = community_2007();
											var community_assignment_result_2010 = community_2010();
											var community_assignment_result_2012 = community_2012();

											var All_data = [];
											var com_date = [];
											com_date[0] = community_1997();
											com_date[1] = community_2000();
											com_date[2] = community_2002();
											com_date[3] = community_2005();
											com_date[4] = community_2007();
											com_date[5] = community_2010();
											com_date[6] = community_2012();
											All_data[0] = community_assignment_result_1997;
											All_data[0].key = "1997";
											All_data[1] = community_assignment_result_2000;
											All_data[1].key = "2000";
											All_data[2] = community_assignment_result_2002;
											All_data[2].key = "2002";
											All_data[3] = community_assignment_result_2005;
											All_data[3].key = "2005";
											All_data[4] = community_assignment_result_2007;
											All_data[4].key = "2007";
											All_data[5] = community_assignment_result_2010;
											All_data[5].key = "2010";
											All_data[6] = community_assignment_result_2012;
											All_data[6].key = "2012";

											
											var ch_int = {};
											for (var i = 0; i < count; i++) {
												ch_int[i] = ALL_DATA[0][i]['industry'];
											}
											for (var y = 0; y < 7; y++) {
												for (var i = 0; i < 17; i++) {
													var temp_in = 0;
													var temp_out = 0;
													for (var j = 0; j < 17; j++) {
														temp_in += parseInt(ALL_DATA[y][j][ch_int[i]]);
														temp_out += parseInt(ALL_DATA[y][i][ch_int[j]]);
														if (parseInt(ALL_DATA[y][i][ch_int[j]]) >= 0)
															continue;
														else {}
													}
													ALL_DATA[y][i]['all_in'] = temp_in;
													ALL_DATA[y][i]['all_out'] = temp_out;
													ALL_DATA[y][i]['ratio'] = temp_in / temp_out;
												}
											}
											var max_ratio = 0;
											for (var y = 0; y < 7; y++) {
												for (var i = 0; i < 17; i++) {
													if (max_ratio < ALL_DATA[y][i]['ratio'])
														max_ratio = ALL_DATA[y][i]['ratio'];
													else
														continue;
												}
											}

											var sankey_data = [];
											var scale_line_width = d3.scale.linear()
												.domain([0, max_ratio])
												.range([5, 50]);

											var sankey_index = 0;
											for (var i = 0; i < 17; i++) {
												sankey_data[sankey_index] = [];
												sankey_data[sankey_index][0] = ch_int[i];
												sankey_data[sankey_index][1] = parseFloat(scale_line_width(ALL_DATA[0][i]['ratio']).toFixed(2));
												sankey_data[sankey_index][2] = All_data[0].key + "_" + All_data[0][i];
												sankey_data[sankey_index][3] = ch_int[i];
												sankey_index++;
											}

											for (i = 0; i < 6; i++) {
												for (var j = 0; j < count; j++) {
													sankey_data[sankey_index] = [];
													sankey_data[sankey_index][0] = All_data[i].key + "_" + All_data[i][j];
													sankey_data[sankey_index][1] = parseFloat(scale_line_width(ALL_DATA[i + 1][j]['ratio']).toFixed(2));
													sankey_data[sankey_index][2] =  All_data[i + 1].key + "_" + All_data[i + 1][j];
													sankey_data[sankey_index][3] = ch_int[j];
													sankey_index++;
												}
											}

											$(document).ready(function () {
											var sankey = new Sankey();
											var start = [];
											for (var i = 0; i < 17; i++) {
												start[i] = nodes[i]['industry'];
											}
											sankey.stack(0, start);
											sankey.stack(1, ["1997_0", "1997_1", "1997_2", "1997_3","1997_4", "1997_5"]);
											sankey.stack(2, ["2000_0", "2000_1", "2000_2", "2000_3","2000_4"]);
											sankey.stack(3, ["2002_0", "2002_1", "2002_2", "2002_3", "2002_4"]);
											sankey.stack(4, ["2005_0", "2005_1", "2005_2", "2005_3", "2005_4"]);
											sankey.stack(5, ["2007_0", "2007_1", "2007_2", "2007_3", "2007_4"]);
											sankey.stack(6, ["2010_0", "2010_1", "2010_2", "2010_3", "2010_4", "2010_5", "2010_6"]);
											sankey.stack(7, ["2012_0", "2012_1", "2012_2", "2012_3", "2012_4", "2012_5", "2012_6"]);
											var data = sankey_data;
											sankey.setData(data);
											sankey.draw();
											});
										var svg_sankey = d3.select("#sankey").selectAll("svg");
										
										svg_sankey.selectAll("rect")
													.on("click",function(d){
														//获取当前年份
														var index = parseInt((this.x.animVal.value - 60)/72) - 1;
														var year_arr = ["1997","2000","2002","2005","2007","2010","2012"];
														//获取当前社区
														var cur_color = this.attributes[7].value;
														var cur_com = color_arr.indexOf(cur_color);
														function chosen_op(){
															var community_assignment_result = com_date[index];
															var cur_index = 0;
															var circle_com = [];
															while(community_assignment_result[cur_index] != null)
															{
																if(circle_com.indexOf(community_assignment_result[cur_index]) == -1){
																	circle_com.push(community_assignment_result[cur_index]);
																}
																cur_index++;											
															}
															console.log(circle_com);
															var com_node_arr = new Array(circle_com.length);
															for(var i = 0; i<com_node_arr.length;i++){
																com_node_arr[i] = [];
															}
															var cur_index = 0;
															while(community_assignment_result[cur_index] != null)
															{
																com_node_arr[community_assignment_result[cur_index]].push(cur_index);
																cur_index++;
															}

															for(var j = 0; j<circle_com.length;j++){
																d3.selectAll("#com_line_"+j).style("opacity","0.2")
															}
															d3.selectAll("#com_line_"+cur_com).style("opacity","1.0")
															for(var j = 0; j < count;j++){
																d3.select("#node_orginal_"+j).style("opacity","0.1");
															}
															for(var j = 0; j< com_node_arr[cur_com].length;j++){
																d3.select("#node_orginal_"+com_node_arr[cur_com][j]).style("opacity","1.0");
															}
															for(var j = 0; j < count;j++){
																d3.select("#node_out"+j).style("opacity","0.1");
															}
															for(var j = 0; j< com_node_arr[cur_com].length;j++){
																d3.select("#node_out"+com_node_arr[cur_com][j]).style("opacity","1.0");
															}
															for (var j = 0; j < 16; j++) {
																for (var n = j+1; n < 17; n++) {
																	if(com_node_arr[cur_com].indexOf(j) != -1  && com_node_arr[cur_com].indexOf(n) != -1){
																		d3.select("#link" + (j) + "to" + (n)).attr("opacity", "0.6");
																		d3.select("#link" + (n) + "to" + (j)).attr("opacity", "0.6");
																		d3.select("#curve_line_"+j+"_"+n).attr("opacity",0);
																	}
																	else{
																		d3.select("#link" + (j) + "to" + (n)).attr("opacity", "0.1");
																		d3.select("#link" + (n) + "to" + (j)).attr("opacity", "0.1");
																		d3.select("#curve_line_"+j+"_"+n).attr("opacity",0);
																	}
																}
															}
															for(var s = 0; s < 17;s++){
																for(var t = 0 ;t < 17 ;t++){
																	if(com_node_arr[cur_com].indexOf(s) != -1 && com_node_arr[cur_com].indexOf(t) != -1){
																		d3.select("#rec_"+s+"_"+t).style("opacity","1.0");
																		d3.selectAll("#rec_circle_"+s+"_"+t).style("opacity","1.0");
																		d3.select("#rec_line_"+s+"_"+t).style("opacity","1.0");
																		
																	}
																	else{
																		d3.select("#rec_"+s+"_"+t).style("opacity","0.2");
																		d3.selectAll("#rec_circle_"+s+"_"+t).style("opacity","0.2");
																		d3.select("#rec_line_"+s+"_"+t).style("opacity","0.1");
																	}
																}
															}
														}
														if(document.getElementById("selectdata").value == year_arr[index])
														{
															chosen_op();
														}
														else{
															var cur_community_result = com_date[index];
															//改变年份下拉框的值
															document.querySelector("#selectdata").value = year_arr[index];
															//改变当前年份的值
															$("#cur_year").val(year_arr[index]);
															$("#cur_year_rec").val(year_arr[index]);
															for(var t = 0;t <count;t++){
																ALL_DATA[index][t].community = 0;
															}
															bg_color(cur_community_result,ALL_DATA[index]);
															draw_rec_time(ALL_DATA[index], cur_community_result, ALL_DATA);
															draw_force(ALL_DATA_1[index],ALL_DATA[index],0.00000001);
															get_com_btn(cur_community_result,ALL_DATA[index],ALL_DATA_1[index],cur_min);
															chosen_op();
															get_community(ALL_DATA[index],ALL_DATA_1[index],cur_min,k);
															$("#k1_value").val(Math.round(k*100)/100);
															slider_k1(ALL_DATA[index],ALL_DATA_1[index],k,cur_min);
															$("#k2_value").val(Math.round((1 - k)*100)/100);
															slider_k2(ALL_DATA[index],ALL_DATA_1[index],k,cur_min);
															if(cur_min < 0.001)
																$("#amount").val(0);
															else
																$("#amount").val(Math.round(cur_min*100)/100);
															slider_MIN(ALL_DATA[index],ALL_DATA_1[index],k,cur_min);
														}
													});
									}
				});
				});
				});
				});
				});
				});
				});
				});
				});
				});
				});
				});
				});
				});
	
</script>
</html>